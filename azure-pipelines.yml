trigger:
  branches:
    include:
      - main

# Allow pipeline to access protected variables
variables:
- group: production-secrets

pool:
  vmImage: ubuntu-latest

#######################################################
#         STAGE 1 — CONTINUOUS INTEGRATION
#######################################################
stages:

- stage: CI
  displayName: "Continuous Integration"
  jobs:
  - job: Build_and_Test
    displayName: "Build + Lint + Tests"
    steps:

    #######################################################
    # Checkout code
    #######################################################
    - checkout: self
      clean: true

    #######################################################
    # Python Setup
    #######################################################
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.11'
        addToPath: true

    #######################################################
    # Install dependencies
    #######################################################
    - script: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
      displayName: "Install Python dependencies"
    
    #######################################################
    # Linting (flake8 — optional but looks professional)
    #######################################################
    - script: |
        pip install flake8
        flake8 app --count --select=E9,F63,F7,F82 --show-source --statistics
      displayName: "Run Linter"

    #######################################################
    # Run Tests (pytest)
    #######################################################
    - script: |
        pip install pytest
        pytest -q
      displayName: "Run Unit Tests"

    #######################################################
    # Build artifact (zip)
    #######################################################
    - script: |
        mkdir build
        zip -r build/app.zip app frontend .env.example requirements.txt
      displayName: "Create Deployable Artifact"

    - publish: build/app.zip
      artifact: drop
      displayName: "Publish Build Artifact"


#######################################################
#         STAGE 2 — CONTINUOUS DEPLOYMENT
#######################################################
- stage: CD
  displayName: "Continuous Deployment"
  dependsOn: CI
  condition: succeeded()
  jobs:

  - deployment: DeployWebApp
    displayName: "Deploy to Azure Web App"
    environment: production

    strategy:
      runOnce:
        deploy:
          steps:

          #######################################################
          # Download artifact from CI stage
          #######################################################
          - download: current
            artifact: drop

          #######################################################
          # Deploy using ZipDeploy API
          #######################################################
          - task: AzureWebApp@1
            displayName: "Deploy FastAPI backend to Azure Web App"
            inputs:
              azureSubscription: "polyglot_webapp_publish"   # your generic service connection
              appType: webApp
              appName: "polyglotcaptions-api"
              package: "$(Pipeline.Workspace)/drop/app.zip"

          #######################################################
          # Verify Deployment (curl health)
          #######################################################
          - script: |
              echo "Checking health endpoint..."
              curl -I https://polyglotcaptions-api-aadtfvffg2g0h7d7.westeurope-01.azurewebsites.net/health
            displayName: "Verify Deployment Health Check"
